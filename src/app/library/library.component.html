<div class="library-container">
  <div class="library-header">
    <div class="library-header-row">
    <button *ngIf="currentFolder" mat-icon-button (click)="navigateToRoot()">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <app-manage-sharing
      *ngIf="currentFolder?.isShared && getCurrentUserRole() === 'editor'"
      [folder]="currentFolder!"
      (sharingUpdated)="onSharingUpdated($event)">
    </app-manage-sharing>
    </div>

    <div *ngIf="searchActive" class="search-overlay" (click)="clearSearch()">
      <div class="search-results" (click)="$event.stopPropagation()">
        <h2>Search Results</h2>

      <div *ngIf="filteredFiles.length > 0 || filteredFolders.length > 0">
        <div class="folders-container">
          <div class="folder-item" *ngFor="let folder of filteredFolders"  (click)="navigateToFolder(folder)">
            <mat-icon class="folder-icon">folder</mat-icon>
            <p class="folder-name">{{ folder.name }}</p>
          </div>
        </div>

        <div class="files-container">
          <h3>Files</h3>
          <div *ngFor="let file of filteredFiles" class="file-item"    (click)="openFile(file)">
            <mat-icon class="file-icon">insert_drive_file</mat-icon>
            <p class="file-name">{{ file.fileName }}</p>
          </div>
        </div>
      </div>

      <div *ngIf="filteredFiles.length === 0 && filteredFolders.length === 0">
        <p>No results found.</p>
      </div>
    </div>
    </div>

    <div *ngIf="!searchActive">
  </div>

  <app-add-button
    *ngIf="!currentFolder?.isShared || getCurrentUserRole() === 'editor'"
    [currentFolder]="currentFolder"
    (folderCreated)="onFolderCreated($event)"
    (fileUploaded)="onFileUploaded($event)">
  </app-add-button>


    <div class="folders-container">
      <div
        *ngFor="let folder of folders"
        class="folder-item"
        [class.shared-folder]="folder.isShared"
        (click)="navigateToFolder(folder)"
        (contextmenu)="onRightClick($event, folder, 'folder')"
        (swiperight)="onSwipeLeft(folder, 'folder')"
        (dragover)="onDragOverFolder($event)"
        (drop)="onDropFile($event, folder)">

        <mat-icon class="folder-icon">folder</mat-icon>
        <div class="folder-info">
          <p class="folder-name">{{ folder.name }}</p>
          <div class="folder-meta">
            <span *ngIf="folder.isShared" class="shared-badge">Shared</span>
            <span *ngIf="folder.isShared && folder.userId !== userId" class="owner-badge">
          (Owner: {{ folder.ownerName || 'Unknown' }})
        </span>
          </div>
        </div>
      </div>
    </div>

<!--    <div *ngIf="currentFolder?.isShared && getCurrentUserRole() === 'editor'" class="manage-sharing-section">-->
<!--      <h3>Manage Folder Sharing</h3>-->
<!--      <div *ngFor="let user of currentFolder.sharedWith" class="shared-user-entry">-->
<!--        <span class="shared-user-email">{{ user.email }}</span>-->

<!--        <select [value]="user.role" (change)="updateUserRole(user.userId, $event.target.value)">-->
<!--          <option value="viewer">Viewer</option>-->
<!--          <option value="editor">Editor</option>-->
<!--        </select>-->
<!--      </div>-->
<!--    </div>-->



  <div class="files-container">
    <h3>Files</h3>

    <div *ngFor="let file of files" class="file-item">
      <mat-icon class="file-icon">insert_drive_file</mat-icon>
      <!-- Show input field when renaming -->
      <input
        *ngIf="file.isRenaming"
        [(ngModel)]="file.newName"
        (keydown.enter)="saveFileName(file)"
        (blur)="saveFileName(file)"
        placeholder="Enter new name"
        class="rename-input"
      />


      <div *ngIf="!file.isRenaming" class="file-display">
      <p
        class="file-name"
        draggable="true"
        (click)="openFile(file)"
        (contextmenu)="onRightClick($event, file, 'file')"
        (swipeleft)="onSwipeLeft(file, 'file')"
        (dragstart)="onDragStartFile($event, file)">
        {{ file.fileName }}
      </p>

        <mat-icon
          class="star-icon"
          [class.favorited]="file.isFavorite"
          (click)="toggleFavorite(file)"
          matTooltip="Mark as favorite"
        >
          {{ file.isFavorite ? 'star' : 'star_border' }}
        </mat-icon>

        <mat-checkbox
          [(ngModel)]="file.practiced"
          (change)="togglePracticed(file, $event.checked)"
          matTooltip="Mark as practiced"
        >
        </mat-checkbox>


        <ng-container *ngIf="!currentFolder?.isShared || getCurrentUserRole() === 'editor'">
          <button class="rename-btn" (click)="enableRename(file)">
            <mat-icon matTooltip="Rename file">edit</mat-icon>
          </button>
          <button class="delete-btn" (click)="deleteFile(file)">
            <mat-icon matTooltip="Delete file">delete</mat-icon>
          </button>
        </ng-container>
      </div>

      <div *ngIf="file.isRenaming" class="rename-actions">
        <button (click)="saveFileName(file)">
          <mat-icon>check</mat-icon>
        </button>
        <button (click)="cancelRename(file)">
          <mat-icon>cancel</mat-icon>
        </button>
      </div>

    </div>
  </div>

</div>
</div>

